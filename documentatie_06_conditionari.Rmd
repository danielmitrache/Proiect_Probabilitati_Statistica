```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("R/03_evenimente.r")
source("R/06_conditionari.R")
```

# 6. Probabilități condiționate și condiționări (Cerința 6)

Folosim aceleași variabile ca în Cerința 3:

\\begin{itemize}
  \\item **I** \\(\\in \\{0,1\\}\\) – indicator de succes final (1 = succes, 0 = eșec final)
  \\item **N** – numărul total de încercări
  \\item **T** – timpul total până la succes sau abandon
\\end{itemize}

Definim evenimentele:
\\begin{itemize}
  \\item \\(A = \\{I=1\\}\\) – cererea are succes final
  \\item \\(B = \\{T \\le t_0\\}\\) – cererea respectă SLA (timp sub prag)
  \\item \\(C = \\{N \\le n_0\\}\\) – cererea reușește rapid (puține retry-uri)
\\end{itemize}

## Implementarea (datele din Cerința 3)

În cod folosim un *wrapper* care simulează un eșantion mare și întoarce (N, T, I).

```{r}
print(simuleaza_date_din_ex3)
```

## a) Estimarea probabilităților condiționate

Estimăm empiric:
- \\(P(A \\mid N \\le n_0)\\) (succes condiționat de “rapid”)
- \\(P(B \\mid A)\\) (SLA condiționat de faptul că am avut succes final)

```{r}
set.seed(42)

M <- 100000
n_max <- 3
p_succes <- 0.7
t_0 <- 400
medie_S <- 150
backoff_fix <- 50

n_0 <- 2

df <- simuleaza_date_din_ex3(
  M = M, n_max = n_max, p_succes = p_succes,
  t_0 = t_0, medie_S = medie_S, backoff_fix = backoff_fix
)

A <- (df$I == 1L)
B <- (df$T <= t_0)
C <- (df$N <= n_0)

P_A_given_C <- mean(A[C])   # P(A|C)
P_B_given_A <- mean(B[A])   # P(B|A)

rez_cond <- data.frame(
  Marime = c(paste0("P(A | N <= ", n_0, ")"), "P(B | A)"),
  Valoare = c(P_A_given_C, P_B_given_A)
)

knitr::kable(rez_cond, digits = 4, caption = "Probabilități condiționate estimate empiric")
```

## b) Speranțe condiționate (timpul mediu condiționat de succes/eșec)

Calculăm:
- \\(E(T \\mid I=1)\\): timpul mediu pentru cererile care reușesc
- \\(E(T \\mid I=0)\\): timpul mediu pentru cererile care eșuează final

```{r}
E_T_given_success <- mean(df$T[df$I == 1L])
E_T_given_fail <- mean(df$T[df$I == 0L])

rez_ET <- data.frame(
  Marime = c("E(T | I = 1)", "E(T | I = 0)"),
  Valoare = c(E_T_given_success, E_T_given_fail)
)

knitr::kable(rez_ET, digits = 4, caption = "Speranțe condiționate estimate empiric")
```

## c) Interpretare (experiența utilizatorului)

- **P(A | N ≤ n0)** arată cât de des reușim “repede” (cu puține retry-uri). Un sistem bun are o probabilitate cât mai mare aici, ceea ce indică stabilitate și erori rare.
- **P(B | A)** arată cât de des respectăm SLA condiționat de faptul că cererea chiar reușește. Dacă această probabilitate este mică, utilizatorii “au succes”, dar “așteaptă prea mult”.
- În mod tipic, **E(T | I=0)** este mai mare decât **E(T | I=1)** deoarece eșecul final consumă toate încercările (și, implicit, toți timpii de procesare + backoff), ceea ce înseamnă latență mare fără rezultat — cea mai proastă experiență pentru utilizator.
