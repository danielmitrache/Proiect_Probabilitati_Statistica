```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("R/03_evenimente.R")
library(ggplot2)
```


# 4. Cereri, retry-uri și evenimente (Cerința 3)

Definim evenimentele cheie asociate unei cereri care trece prin mecanismul de retry:

*   $A = \{I = 1\}$: Cererea este procesată cu succes (indiferent de numărul de încercări).
*   $B = \{T \le t_0\}$: Cererea se încadrează în timpul limită setat de SLA (Service Level Agreement).
*   $C = \{N \le n_0\}$: Cererea este soluționată rapid, într-un număr mic de încercări.
*   $D = \{\text{cel puțin un eșec}\}$: Cererea a întâmpinat dificultăți (măcar un eșec), chiar dacă a reușit sau nu la final.

În simularea noastră, vom considera următorii parametri:
*   $n_0 = 2$ (pragul pentru "puține încercări")
*   $t_0 = 400$ ms (pragul de timp SLA)
*   $M = 10000$ simulări

```{r}
#' Simuleaza o singura cerere care poate avea mai multe retry-uri
#' 
#' @param n_max Numarul maxim de incercari permise (retry-uri + prima incercare)
#' @param p_succes Probabilitatea de succes a unei singure incercari (U_i)
#' @param t_0 Pragul de timp pentru respectarea SLA (Service Level Agreement)
#' @param medie_S Timpul mediu de procesare pentru o singura incercare (S_i)
#' @param backoff_fix Timpul de asteptare fix adaugat intre doua reincercari (B_i)
#' 
#' @return O lista continand indicatori de succes, timp si numar de incercari
print(simuleaza_o_cerere)
```

## a) Estimați empiric: $P(A), P(B), P(C), P(A \cap B), P(A \cup D)$

Vom rula simularea Monte Carlo și vom calcula frecvențele relative ale apariției acestor evenimente.

```{r}
set.seed(123)
M <- 10000    
n0_prag <- 2  
t0_prag <- 400 

rezultate <- replicate(M, simuleaza_o_cerere(n_max = 3, p_succes = 0.7, t_0 = t0_prag))
df_cereri <- as.data.frame(t(rezultate))
df_cereri[] <- lapply(df_cereri, unlist)

# Definirea logica a evenimentelor pentru fiecare simulare
ev_A <- (df_cereri$I == 1)
ev_B <- (df_cereri$T <= t0_prag)
ev_C <- (df_cereri$N <= n0_prag)
ev_D <- (df_cereri$D == TRUE)

# Estimare Probabilitati (Frecvente Relative)
prob_A <- mean(ev_A)
prob_B <- mean(ev_B)
prob_C <- mean(ev_C)
prob_inter_AB <- mean(ev_A & ev_B)
prob_reuniune_AD <- mean(ev_A | ev_D)

# Afisare Tabelara
rezultate_sim <- data.frame(
  Eveniment = c("P(A) [Succes]", "P(B) [SLA]", "P(C) [Rapid]", "P(A inter B)", "P(A U D)"),
  Probabilitate_Empirica = c(prob_A, prob_B, prob_C, prob_inter_AB, prob_reuniune_AD)
)

knitr::kable(rezultate_sim, digits = 4, caption = "Probabilități Empirice Estimate")
```

Grafic, aceste probabilități sunt distribuite astfel:

```{r, echo=FALSE, fig.height=4, fig.width=6, fig.align='center'}
ggplot(rezultate_sim, aes(x = Eveniment, y = Probabilitate_Empirica)) +
  geom_bar(stat = "identity", fill = "steelblue", width = 0.6) +
  geom_text(aes(label = round(Probabilitate_Empirica, 3)), vjust = -0.5) +
  ylim(0, 1.1) +
  theme_minimal() +
  labs(title = "Probabilități Estimate", x = NULL, y = "Probabilitate") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## b) Verificați numeric formulele pentru reuniune/intersecție

O proprietate fundamentală a teoriei probabilităților este **Principiul Incluziunii și Excluziunii**. Pentru două evenimente $A$ și $D$, relația este:
$$P(A \cup D) = P(A) + P(D) - P(A \cap D)$$

Verificăm dacă datele noastre respectă această relație:

```{r}
# Calculam elementele componente din datele empirice
prob_D <- mean(ev_D)
prob_inter_AD <- mean(ev_A & ev_D) 

# Aplicam formula teoretica folosind valorile estimate
valoare_formula <- prob_A + prob_D - prob_inter_AD

# Comparam cu valoarea obtinuta direct prin numarare (reuniune logica)
cat("P(A U D) măsurat direct (reuniune logica):", prob_reuniune_AD, "\n")
cat("P(A) + P(D) - P(A inter D) (formula):      ", valoare_formula, "\n")
cat("Diferența (Eroare de calcul):              ", abs(prob_reuniune_AD - valoare_formula), "\n")
```

Diferența zero confirmă că relațiile dintre mulțimi se păstrează perfect în eșantionul nostru.

## c) Explicați de ce probabilitatea empirică aproximează bine probabilitatea teoretică

Motivul pentru care putem folosi simularea ($M=10000$ cazuri) pentru a estima probabilitățile reale ale sistemului este **Legea Numerelor Mari (LLN)**.

Această lege afirmă că, pe măsură ce dimensiunea eșantionului ($M$) crește, media empirică (frecvența relativă a observării unui eveniment) converge în probabilitate către media teoretică (probabilitatea reală a evenimentului).

Formal, dacă $X_1, X_2, ..., X_M$ sunt variabile aleatoare independente și identic distribuite (i.i.d.) care indică apariția unui eveniment (1 dacă apare, 0 altfel), atunci media lor aritmetică $\bar{X}_M$ satisface:
$$ \lim_{M \to \infty} P(|\bar{X}_M - \mu| < \epsilon) = 1 $$
Unde $\mu$ este probabilitatea teoretică.

În cazul nostru, $M=10000$ este un număr suficient de mare pentru ca fluctuațiile statistice să se "anuleze" reciproc, rezultând o estimare care este foarte apropiată de valoarea "adevărată" pe care am obține-o prin calcul analitic exact. Eroarea de estimare scade proporțional cu $1/\sqrt{M}$.


